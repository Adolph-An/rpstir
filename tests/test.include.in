# Shell function for checking if the number of lines of output matches
# the expected number.

export TESTS_TOP_BUILDDIR="@abs_top_builddir@"
export TESTS_TOP_SRCDIR="@abs_top_srcdir@"

. "$TESTS_TOP_SRCDIR/lib/util/shell_utils"

check_num_output_lines()
{
    # Parameter 1 is the command line.
    # Parameter 2 is the error message if command returns nonzero.
    # Parameter 3 is the number of expected output lines.
    # If anything fails, exit the script with the right error code.

    TMPFILE=`@MKTEMP@` || \
        check_errs $? "$0 could not create temp file"

    CMDLINE=${1}		# re-wordsplit on whitespace
    $CMDLINE | tee $TMPFILE || check_errs $? "$0 ${2}"

    NUMLINES=$(cat $TMPFILE | wc -l)
    rm $TMPFILE
    [ $NUMLINES -eq "${3}" ] || \
        check_errs $? "$0 incorrect output: $NUMLINES lines (expected ${3})"

    return 0
}

run_bg () {
    LOG="$1"
    shift || exit 1
    PROG="$1"
    shift || exit 1

    log_dir="."
    if test -n "$TEST_LOG_DIR"; then
        log_dir="$TEST_LOG_DIR"
    fi

    case "$CHECKTOOL" in
        "valgrind")
            if test "x$STRICT_CHECKS" = x1; then
                valgrind --log-file="$log_dir/valgrind.$TEST_LOG_NAME.$LOG.log" --track-fds=full --leak-check=full --error-exitcode=1 "$PROG" "$@" <&0 &
            else
                valgrind --log-file="$log_dir/valgrind.$TEST_LOG_NAME.$LOG.log" --error-exitcode=1 "$PROG" "$@" <&0 &
            fi
            ;;
        "" | "none")
            "$PROG" "$@" <&0 &
            ;;
        *)
            echo >&2 "Error: invalid value for \$CHECKTOOL: $CHECKTOOL"
            exit 1
    esac
}

run () {
    run_bg "$@" || return $?
    wait $! || return $?
    return 0
}

# Any test that calls use_config_file() should ensure that the config file
# it uses includes $TESTS_INCLUDE_CONFIG.
export TESTS_INCLUDE_CONFIG="$TESTS_TOP_SRCDIR/tests/test.conf"
use_config_file () {
    test $# -eq 1 || fatal "Usage: $0 path/to/file.conf"

    export @CONFIG_ENV_VAR@="$1"
}
