# run test 8
# checks: roa validation
# currently requires addition to sqhl.c of line
#   sta = 0; chainOK = 1;
# right after the comment to actually add the certificate

echo ""
echo "Running test 8"
echo "delete from apki_cert;" | mysql $APKI_DB -u mysql
echo "delete from apki_roa;" | mysql $APKI_DB -u mysql
$APKI_ROOT/rsync_aur/rsync_aur -s -t $APKI_PORT -f $APKI_ROOT/testing/testAdd5 -d $APKI_ROOT/testing/REPOSITORY
echo "Should be an ski:"
echo "select ski from apki_roa where flags=4;" | mysql $APKI_DB -u mysql
echo "delete from apki_cert;" | mysql $APKI_DB -u mysql
echo "delete from apki_roa;" | mysql $APKI_DB -u mysql
$APKI_ROOT/rsync_aur/rsync_aur -s -t $APKI_PORT -f $APKI_ROOT/testing/testAdd6 -d $APKI_ROOT/testing/REPOSITORY
echo "Should be an ski:"
echo "select ski from apki_roa where flags=4;" | mysql $APKI_DB -u mysql
echo "update apki_cert set aki=ski;" | mysql $APKI_DB -u mysql
echo "update apki_cert set issuer=subject;" | mysql $APKI_DB -u mysql
echo "Should be a filter entry:"
$APKI_ROOT/proto/query -a
