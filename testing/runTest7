#!/bin/sh

# set environment variables if not set
THIS_SCRIPT_DIR=$(dirname $(which $0))
source $THIS_SCRIPT_DIR/../envir.setup

# run test 7
# checks: roa operations

echo ""
echo "Running test 7"
$RPKI_ROOT/rsync_aur/rsync_aur -s -t $RPKI_PORT -f $RPKI_ROOT/testing/testAdd4 -d $RPKI_ROOT/testing/REPOSITORY
echo "update apki_cert set ski=\"B4:4D:ED:FD:28:98:01:6E:41:18:30:25:66:A1:6C:C5:B5:BA:CD:75\" where local_id=8;" | $RPKI_MYSQL_CMD
echo "update apki_roa set flags=4;" | $RPKI_MYSQL_CMD
echo "Check filter entry:"
$RPKI_ROOT/proto/query -a
$RPKI_ROOT/proto/garbage
echo "After garbage collection (0 entries):"
$RPKI_ROOT/proto/query -a
echo ""
echo "update apki_crl set next_upd=\"2007-08-02 00:00:00\";" | $RPKI_MYSQL_CMD
$RPKI_ROOT/proto/garbage
echo "After modifying expiration date and garbage collection (1 entries):"
$RPKI_ROOT/proto/query -a
$RPKI_ROOT/rsync_aur/rsync_aur -s -t $RPKI_PORT -f $RPKI_ROOT/testing/testDelete2 -d $RPKI_ROOT/testing/REPOSITORY
echo "Should be 1 entry (no validity check):"
$RPKI_ROOT/proto/query -t roa -d ski
echo "Should be 0 entries (validity check):"
$RPKI_ROOT/proto/query -t roa -d ski -v
