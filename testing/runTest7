# run test 7
# checks: roa operations

echo ""
echo "Running test 7"
$APKI_ROOT/rsync_aur/rsync_aur -s -t $APKI_PORT -f $APKI_ROOT/testing/testAdd4 -d $APKI_ROOT/testing/REPOSITORY
echo "update apki_cert set ski=\"B4:4D:ED:FD:28:98:01:6E:41:18:30:25:66:A1:6C:C5:B5:BA:CD:75\" where local_id=8;" | mysql $APKI_DB -u mysql
echo "update apki_roa set flags=4;" | mysql $APKI_DB -u mysql
echo "Check filter entry:"
$APKI_ROOT/proto/query -a
$APKI_ROOT/proto/garbage
echo "After garbage collection (0 entries):"
$APKI_ROOT/proto/query -a
echo ""
echo "But should be here: cat unknown.out"
cat unknown.out
echo "update apki_crl set next_upd=\"2007-08-02 00:00:00\";" | mysql $APKI_DB -u mysql
$APKI_ROOT/proto/garbage
echo "After modifying expiration date and garbage collection (1 entries):"
$APKI_ROOT/proto/query -a
$APKI_ROOT/rsync_aur/rsync_aur -s -t $APKI_PORT -f $APKI_ROOT/testing/testDelete2 -d $APKI_ROOT/testing/REPOSITORY
echo "Should be 1 entry (no validity check):"
$APKI_ROOT/proto/query -t roa -d ski
echo "Should be 0 entries (validity check):"
$APKI_ROOT/proto/query -t roa -d ski -v
