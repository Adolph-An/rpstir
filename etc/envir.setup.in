#!/bin/sh
#

# Sets up the environment variables for the RPKI relying party system,
# but allows the user to override by setting existing variables.
#
# This file should NOT be executed on its own.  It should be imported
# at the beginning of another script using "source" or ". ".  It is
# useless to execute this file standalone, since "export" can only
# affect the environment of child processes, not parent processes.
#
# Example:
# # set environment variables if not set
# THIS_SCRIPT_DIR=$(dirname $0)
# . $THIS_SCRIPT_DIR/../envir.setup
#


# Path to transitional configuration file
if [ -z "$RPSTIR_CONFIG" ]; then
    export RPSTIR_CONFIG="@ABS_TOP_SRCDIR@/etc/rpstir.conf"
fi

CONFIG_ROOT_DIR=`config_get RootDir`


# MySQL command line which reads statements from stdin
export RPKI_MYSQL_CMD="mysql `config_get Database` -u `config_get DatabaseUser`"

# XXX: password should not be in environment variable or on command line
if DBPASS=`config_get DatabasePassword 2>/dev/null`; then
    export RPKI_MYSQL_CMD="$RPKI_MYSQL_CMD -p$DBPASS"
fi
unset DBPASS


# add all binaries to the path
BIN_DIRS="`@MKTEMP@`"
find "$RPKI_ROOT/bin" -type d -print > "$BIN_DIRS"
while read path_dir; do
    case "$path_dir" in
        */tests | */tests/*)
            ;;
        *)
            PATH="$path_dir:$PATH"
            ;;
    esac
done < "$BIN_DIRS"
export PATH
rm -f "$BIN_DIRS"
unset BIN_DIRS

############################################################################
# Shell function for checking return codes for error (swiped from
# http://steve-parker.org/sh/exitcodes.shtml)
#
# Usage:
# grep "^${1}:" /etc/passwd > /dev/null 2>&1
# check_errs $? "User ${1} not found in /etc/passwd"
# USERNAME=`grep "^${1}:" /etc/passwd|cut -d":" -f1`
# check_errs $? "Cut returned an error"
# echo "USERNAME: $USERNAME"
# check_errs $? "echo returned an error - very strange!"
#
# NOTE: DEPRECATED!  Better to use trap_errors at the top of your
# script, which causes an exit and prints script/line number on any
# error.

check_errs()
{
  # Function. Parameter 1 is the return code
  # Para. 2 is text to display on failure.
  if [ "${1}" -ne "0" ]; then
    echo "ERROR # ${1} : ${2}"
    # as a bonus, make our script exit with the right error code.
    exit ${1}
  fi
}

############################################################################

ensure_file_exists ( ) {
    if [ ! -e "$1" ]
    then
	echo "Error: file not found - $1" 1>&2
	exit 1
    fi
}

ensure_dir_exists ( ) {
    if [ ! -d "$1" ]
    then
        echo "Error: directory not found - $1" 1>&2
        exit 1
    fi
}
