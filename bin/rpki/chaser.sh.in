#!@SHELL_BASH@ -e
#


# set environment variables if not set
THIS_SCRIPT_DIR=`dirname "$0"`
. $THIS_SCRIPT_DIR/../../etc/envir.setup

CHASER_LOG="$RPKI_ROOT/chaser.log"
RSYNC_CORD_CONF="$CONFIG_ROOT_DIR/rsync_cord.config"
BAD_URI_CHARS='['\''",;&(){}|<>!$`\\[:space:][:cntrl:]]\|\[\|\]'

touch "$CHASER_LOG"

DONE_LIST="`@MKTEMP@`" # URIs already fetched from or discarded
CUR_LIST="`@MKTEMP@`" # current set of URIs that we know about
ADDED_LIST="`@MKTEMP@`" # CUR_LIST minus DONE_LIST

chaser -s "$@" | sort > "$CUR_LIST"
cat "$CUR_LIST" > "$ADDED_LIST"

log () {
	echo "`date`" "$@" >> "$CHASER_LOG"
	echo "$@" >&2
}

# Check for the latest version.
if test "$RPKI_NEW_VERSION_CHECK" != none; then
	VERSION_FILE="`@MKTEMP@`"
	if curl \
		--cacert "$RPKI_ROOT/etc/version-server-ca.pem" \
		--location \
		--max-time 5 \
		--output "$VERSION_FILE" \
		"$RPKI_NEW_VERSION_CHECK"
	then
		LATEST_VERSION="$(head -n 1 "$VERSION_FILE")"
		if test "@PACKAGE_VERSION@" != "$LATEST_VERSION"; then
			log "A new version of @PACKAGE_NAME@, $LATEST_VERSION, is available."
		fi
	else
		log "Can't download version information from $RPKI_NEW_VERSION_CHECK"
	fi
	rm "$VERSION_FILE"
fi

while test -s "$ADDED_LIST"; do
	rm -f "$RSYNC_CORD_CONF"

	echo "RSYNC=\"`which rsync`\"" >> "$RSYNC_CORD_CONF"
	echo "REPOSITORY=\"$CONFIG_ROOT_DIR/REPOSITORY\"" >> "$RSYNC_CORD_CONF"
	echo "LOGS=\"$CONFIG_ROOT_DIR/LOGS\"" >> "$RSYNC_CORD_CONF"

	DONE_URI=0
	printf "DIRS=\"" >> "$RSYNC_CORD_CONF"
	while read -r URI; do
		if printf "%s" "$URI" | grep -q "$BAD_URI_CHARS"; then
			log "Discarding URI: $URI"
		elif test -n "$URI"; then
			if test $DONE_URI -eq 0; then
				DONE_URI=1
			else
				printf " " >> "$RSYNC_CORD_CONF"
			fi
			printf "%s" "$URI" | sed 's!^rsync://!!i' | sed 's!/$!!' >> "$RSYNC_CORD_CONF"
		fi
	done < "$ADDED_LIST"
	echo "\"" >> "$RSYNC_CORD_CONF"

	rsync_cord.py -d -c "$RSYNC_CORD_CONF" \
		-t "`config_get DownloadConcurrency`"

	NEW_DONE_LIST="`@MKTEMP@`"
	cat "$DONE_LIST" "$ADDED_LIST" | sort | uniq > "$NEW_DONE_LIST"
	rm -f "$DONE_LIST"
	DONE_LIST="$NEW_DONE_LIST"
	unset NEW_DONE_LIST

	chaser -s "$@" | sort > "$CUR_LIST"

	comm -13 "$DONE_LIST" "$CUR_LIST" > "$ADDED_LIST"
done

rm -f "$DONE_LIST" "$CUR_LIST" "$ADDED_LIST"
