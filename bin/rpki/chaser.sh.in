#!@SHELL_BASH@ -e
#

@SETUP_ENVIRONMENT@

CHASER_LOG="`config_get LogDir`/chaser.log"
BAD_URI_CHARS='['\''",;&(){}|<>!$`\\[:space:][:cntrl:]]\|\[\|\]'

touch "$CHASER_LOG"

OLD_LIST="`@MKTEMP@`"
CUR_LIST="`@MKTEMP@`"

chaser "$@" > "$CUR_LIST"

log () {
	echo "`date`" "$@" >> "$CHASER_LOG"
	echo "$@" >&2
}

while ! cmp -s "$OLD_LIST" "$CUR_LIST"; do
	RSYNC_CORD_CONF="`@MKTEMP@`"

	echo "RSYNC=\"`which rsync`\"" >> "$RSYNC_CORD_CONF"
	echo "REPOSITORY=\"`config_get RPKICacheDir`\"" >> "$RSYNC_CORD_CONF"
	echo "LOGS=\"`config_get LogDir`\"" >> "$RSYNC_CORD_CONF"

	DONE_URI=0
	printf "DIRS=\"" >> "$RSYNC_CORD_CONF"
	while read -r -d "" URI; do
		if printf "%s" "$URI" | grep -q "$BAD_URI_CHARS"; then
			log "Discarding URI: $URI"
		elif test -n "$URI"; then
			if test $DONE_URI -eq 0; then
				DONE_URI=1
			else
				printf " " >> "$RSYNC_CORD_CONF"
			fi
			printf "%s" "$URI" | sed 's!^rsync://!!i' | sed 's!/$!!' >> "$RSYNC_CORD_CONF"
		fi
	done < "$CUR_LIST"
	echo "\"" >> "$RSYNC_CORD_CONF"

	rsync_cord.py -d -c "$RSYNC_CORD_CONF" \
		-t "`config_get DownloadConcurrency`"

	rm -f "$RSYNC_CORD_CONF"

	rm -f "$OLD_LIST"
	OLD_LIST="$CUR_LIST"
	CUR_LIST="`@MKTEMP@`"
	chaser "$@" > "$CUR_LIST"
done

rm -f "$OLD_LIST" "$CUR_LIST"
